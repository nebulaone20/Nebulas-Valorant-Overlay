<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Nebulas Overlay — Console</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
:root {
    --bg:#0f1113; --panel:#121316; --muted:#9aa4b2;
    --accent:#1db954; --card-border:rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
body{
    margin:0;font-family:Inter,"Segoe UI",Arial,sans-serif;
    background:linear-gradient(180deg,#0b0c0d,#0f1113);
    color:#e6eef6
}
header{
    padding:18px 28px;display:flex;align-items:center;
    border-bottom:1px solid var(--card-border)
}
.container{display:flex;gap:20px;padding:22px}
nav{
    width:220px;background:var(--panel);border-radius:8px;
    padding:12px;border:1px solid var(--card-border)
}
.area-btn{
    width:100%;padding:10px;margin-bottom:8px;
    background:transparent;color:var(--muted);
    border-radius:6px;border:0;cursor:pointer;text-align:left
}
.area-btn.active{color:#fff;background:rgba(255,255,255,.04)}
main{flex:1;min-width:600px}
.panel{
    background:linear-gradient(180deg,rgba(255,255,255,.01),transparent);
    border-radius:10px;padding:18px;margin-bottom:18px;
    border:1px solid var(--card-border)
}
.panel h2{margin:0 0 12px;font-size:16px}
.row{display:flex;gap:12px;align-items:center}
label{font-size:13px;color:var(--muted)}
input{
    padding:9px 10px;border-radius:8px;background:#0b0d0f;
    color:#eaf0f8;border:1px solid rgba(255,255,255,.03)
}
button{
    padding:10px 12px;border-radius:8px;border:0;
    cursor:pointer;background:var(--accent);
    color:#fff;font-weight:600
}
.hidden{display:none!important}
.muted{color:var(--muted);font-size:13px}
.timer-inputs input{width:80px}
</style>
</head>

<body>

<header>
    <h1>Nebulas Overlay — Console</h1>
    <div style="margin-left:auto" class="muted">Signed in: local</div>
</header>

<div class="container">
<nav>
    <button class="area-btn active" data-panel="intermission">Intermission</button>
    <button class="area-btn" data-panel="settings">Settings</button>
</nav>

<main>

<section id="panel-intermission" class="panel">
<h2>Intermission — Live Controls</h2>

<!-- SPOTIFY -->
<label>Spotify</label>
<div class="row" style="margin:10px 0">
    <button id="spotify-connect">Connect Spotify</button>
    <button id="spotify-disconnect" style="background:#c43" class="hidden">Disconnect</button>
</div>
<div id="spotify-status" class="muted">Not connected</div>

<hr style="margin:16px 0">

<!-- TRI -->
<label>Team TRI Codes</label>
<div class="row" style="margin-top:10px">
    <input id="tri-top" maxlength="4" placeholder="TOP">
    <input id="tri-bottom" maxlength="4" placeholder="BOT">
    <button id="apply-tri">Apply</button>
</div>

<hr style="margin:16px 0">

<!-- TIMER -->
<label>Intermission Timer</label>
<div class="row timer-inputs" style="margin-top:10px">
    <input id="h" type="number" min="0" max="99" value="0">
    <input id="m" type="number" min="0" max="59" value="5">
    <input id="s" type="number" min="0" max="59" value="0">
</div>

<div class="row" style="margin-top:10px">
    <button id="timer-start">Start</button>
    <button id="timer-stop" style="background:#c43">Stop</button>
    <button id="timer-reset" style="background:#666">Reset</button>
</div>
</section>

<section id="panel-settings" class="panel hidden">
<h2>Settings</h2>
<p class="muted">Spotify redirect must match this page URL.</p>
</section>

</main>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
    apiKey: "AIzaSyCZaiLNBoOtcPPaCupRXAttm0KlV8xuMUw",
    authDomain: "nebulas-overlay.firebaseapp.com",
    databaseURL: "https://nebulas-overlay-default-rtdb.firebaseio.com",
    projectId: "nebulas-overlay",
    storageBucket: "nebulas-overlay.firebasestorage.app",
    messagingSenderId: "369414654740",
    appId: "1:369414654740:web:808bff413fd75084b15001"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= NAV ================= */
document.querySelectorAll(".area-btn").forEach(btn=>{
    btn.onclick=()=>{
        document.querySelectorAll(".area-btn").forEach(b=>b.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(p=>p.classList.add("hidden"));
        btn.classList.add("active");
        document.getElementById("panel-"+btn.dataset.panel).classList.remove("hidden");
    };
});

/* ================= TRI ================= */
apply-tri.onclick = () => {
    db.ref("intermission/tags").set({
        top: tri-top.value || "[TOP]",
        bottom: tri-bottom.value || "[BOT]"
    });
};

/* ================= TIMER ================= */
function duration(){
    return (+h.value*3600)+(+m.value*60)+(+s.value);
}
timer-start.onclick = ()=>{
    const d=duration(); if(d<=0)return;
    db.ref("intermission/timer").set({
        duration:d,start_at:Date.now(),running:true
    });
};
timer-stop.onclick = ()=>{
    db.ref("intermission/timer").once("value").then(s=>{
        const v=s.val(); if(!v||!v.running)return;
        const e=Math.floor((Date.now()-v.start_at)/1000);
        db.ref("intermission/timer").set({
            duration:Math.max(0,v.duration-e),
            start_at:0,running:false
        });
    });
};
timer-reset.onclick = ()=>{
    db.ref("intermission/timer").set({
        duration:duration(),start_at:0,running:false
    });
};

/* ================= SPOTIFY ================= */
const CLIENT_ID = "36304abf3c674b89ba2489ab3e554e0b";
const REDIRECT = location.origin + location.pathname;
const scopes = "user-read-currently-playing";

function updateSpotifyUI(){
    const token = localStorage.getItem("spotify_access_token");
    spotify-connect.classList.toggle("hidden",!!token);
    spotify-disconnect.classList.toggle("hidden",!token);
    spotify-status.textContent = token ? "Connected" : "Not connected";
}

spotify-connect.onclick=()=>{
    location.href =
        "https://accounts.spotify.com/authorize"+
        "?response_type=token"+
        "&client_id="+CLIENT_ID+
        "&scope="+encodeURIComponent(scopes)+
        "&redirect_uri="+encodeURIComponent(REDIRECT);
};

spotify-disconnect.onclick=()=>{
    localStorage.removeItem("spotify_access_token");
    updateSpotifyUI();
};

if(location.hash.includes("access_token")){
    const p=new URLSearchParams(location.hash.substring(1));
    localStorage.setItem("spotify_access_token",p.get("access_token"));
    history.replaceState({},document.title,REDIRECT);
}
updateSpotifyUI();
</script>

</body>
</html>
